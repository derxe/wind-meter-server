{% from '_flask_macros.html' import sleep_overlay, loading_overlay %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.85, maximum-scale=3" />
  <title>{{ station.full_name }}: veterna postaja</title>
  <!-- Tailwind via CDN (no app JS) -->
  <!-- <script src="https://cdn.tailwindcss.com"></script>
  <script src="static/css/tailwind-3-4-17.min.js"></script> -->

  <script data-goatcounter="https://stats.to-ni.dev/count" async src="//stats.to-ni.dev/count.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="static/js/shared.js"></script>
  <script src="static/js/wind_rose.js"></script>
  <script src="static/js/status_update.js"></script>
  <script src="static/js/wind.js"></script>
  <script src="static/js/temps.js"></script>

  <style>

    html {
      touch-action: manipulation; /* disable double-tap zooming */
    }
    /*
    to disable double-tap zooming on iOS Safari
    we need something like that supposedly since the touch-action is ignored
    but we dont care about that OS so I wont bother with it lol
        let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
    */

    @media (min-width: 1024px) {
      .status-border {
        mask-image: linear-gradient(
          to right,
          transparent 0%,
          black 20%,
          black 80%,
          transparent 100%
        );
        -webkit-mask-image: linear-gradient(
          to right,
          transparent 0%,
          black 20%,
          black 80%,
          transparent 100%
        );
      }
    }

    /* Base for all statuses on #header */
    #header .status-border {
      background: linear-gradient(
        180deg,
        var(--status-border-top) 4%,
        var(--status-border-mid) 10%,
        rgba(255, 255, 255, 0) 53%
      );
    }

    #header .status-badge {
      background-color: var(--status-badge-bg);
      color: var(--status-badge-fg);
      border-color: var(--status-badge-border);
    }

    #header .status-dot {
      background-color: var(--status-dot-bg);
    }

    /* This keeps your original ‚Äúdiv div‚Äù behavior but driven by a variable */
    #header div div {
      background-color: var(--status-inner-bg, transparent);
    }

    /* === OK (emerald) === */
    #header.status-ok {
      --status-border-top: rgba(16, 185, 129, 1);
      --status-border-mid: rgba(16, 185, 129, 0.21);

      --status-badge-bg: rgb(236, 253, 245);
      --status-badge-fg: rgb(4, 120, 87);
      --status-badge-border: rgb(167, 243, 208);

      --status-dot-bg: rgb(16, 185, 129);
      --status-inner-bg: rgba(236, 253, 245, 0.05);
    }

    /* === Offline (slate) === */
    #header.status-offline {
      --status-border-top: rgba(148, 163, 184, 1);
      --status-border-mid: rgba(148, 163, 184, 0.21);

      --status-badge-bg: rgb(248, 250, 252);
      --status-badge-fg: rgb(71, 85, 105);
      --status-badge-border: rgb(226, 232, 240);

      --status-dot-bg: rgb(148, 163, 184);
      --status-inner-bg: rgba(248, 250, 252, 0.1);
    }

    /* === Sleeping (cyan) === */
    #header.status-sleeping {
      --status-border-top: rgba(34, 211, 238, 1);
      --status-border-mid: rgba(34, 211, 238, 0.21);

      --status-badge-bg: rgb(236, 254, 255);
      --status-badge-fg: rgb(14, 116, 144);
      --status-badge-border: rgb(165, 243, 252);

      --status-dot-bg: rgb(34, 211, 238);
      --status-inner-bg: rgba(236, 254, 255, 0.2);
    }

    /* === Error (rose) === */
    #header.status-error {
      --status-border-top: rgba(244, 63, 94, 1);
      --status-border-mid: rgba(244, 63, 94, 0.21);

      --status-badge-bg: rgb(255, 241, 242);
      --status-badge-fg: rgb(190, 18, 60);
      --status-badge-border: rgb(254, 205, 211);

      --status-dot-bg: rgb(244, 63, 94);
      --status-inner-bg: rgba(255, 241, 242, 0.1);
    }

    /* === Non-Responsive (amber) === */
    #header.status-non-responsive {
      --status-border-top: rgba(251, 191, 36, 1);
      --status-border-mid: rgba(251, 191, 36, 0.21);

      --status-badge-bg: rgb(255, 251, 235);
      --status-badge-fg: rgb(146, 64, 14);
      --status-badge-border: rgb(254, 240, 138);

      --status-dot-bg: rgb(251, 191, 36);
      --status-inner-bg: rgba(255, 251, 235, 0.1);
    }

    .tooltip{
      position:absolute; 
      padding:8px 10px; 
      font-size:12px; 
      border-radius:8px; 
      backdrop-filter:blur(6px); 
      background:rgba(25,35,60,.72); 
      color:var(--ink); 
      transform:translate(-50%, -120%); 
      white-space:nowrap; 
      pointer-events:none; 
      opacity:0; 
      transition:opacity .12s ease;
      z-index: 30;
    }

    .legend {
       display: flex; 
       justify-content: center; 
       align-items: flex-end;
       flex-wrap: wrap; 
       gap: 5px; 
       min-width: 310px;
       text-align: center; 
    }

    .legend-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      min-width: 30px; /* keeps spacing even */
    }

    .legend-value {
      font-size: 10px;
      color:grey;
      top: -15px;
      position: absolute;
      width: 100%;
    }

    .chip {
      border-radius: 4px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      transition: height 0.3s ease;
    }

    .chip-label {
      position: absolute;
      top: -17px;          /* distance above the bar */
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: grey;
      pointer-events: none;
    }

    .chip-holder {
      height: 60px;
      width: 28px;
    }

    @media (max-width: 1024px) {
      .legend {
        gap: 10px; 
      }

      .chip-holder {
        height: 85px;
        width: 35px;
      }
    }

    

    .legend-label {
      font-size: 10px;
      padding-top: 5px;
      color: var(--ink, #0b1220);
      white-space: nowrap;
      font-weight: bold;
    }
  </style>
</head>

<script>
  stationData = {{ station | tojson }};
  preloadedStatusData =  {{ statusData | tojson }}; 
  preloadedWindData =  {{ windData | tojson }}; 
  preloadedTempData =  {{ tempData | tojson }}; 
</script>

<script>
  /*
  // There was a problem with cloudgorge which prevented the tailwind to load so this is a 
  // workaround to apply constant height for the cavas sie in order to prevent canvas 
  // to be constatly resizable into higher and higher sizes 
  $(function () {
    // Tailwind Browser v4 exposes a global "tailwind" object.
    // If it's missing, we assume Tailwind failed to load.
    if (!window.tailwind) {
      console.log("There is not tailwind??");
      $('.chart-holder').each(function () {
        $(this).css('height', '600px');
      });
    }
  });
  */
</script>

<script>
  $(function() {
    if(stationData.message) {
      $("#station-msg-box").show();
      $("#station-msg").html(stationData.message);
    }

    $("#back-btn").click(() => {
      window.location.pathname = "";
    })
  })
</script>

<body class="min-h-screen bg-indigo-50 text-slate-900" style="min-width:440px"> <!-- bg-sky-100 -->


  <div id="header" class="">
    <div class="relative bg-white" >
    <div class="relative" >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 pb-3 pt-3 flex items-center justify-between">
        <div class="flex flex-col gap-2">
        <!-- Title row -->
        <div class="flex items-center gap-2">
          <button
            id="back-btn"
            class="w-9 h-9 flex items-center justify-center rounded-xl text-slate-600
                  hover:bg-slate-200 active:bg-slate-300 transition"
            aria-label="Back">
            <svg xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
              <path stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <h1 class="text-lg leading-tight">
            Vetrna Postaja ‚Äì
            <span class="text-xl font-semibold">
              {{ station.full_name }}
            </span>
          </h1>
        </div>

        <!-- Status row -->
        <div class="flex items-center gap-2 ml-">
          <span class="status-badge inline-flex items-center gap-1 rounded-lg text-xs px-2 py-0.5 border">
            <span class="status-dot w-1.5 h-1.5 rounded-full"></span>
            <span id="status-bubble-text" class="pl-[2px] whitespace-nowrap">
              Deluje
            </span>
          </span>

          <span id="status-detailed-text"
                class="text-xs text-slate-500">
            ---
          </span>
        </div>
      </div>



      </div>

      </div>
    </div>

    <div class="relative flex items-center justify-center w-full h-[30px] overflow-hidden">
      <div class="status-border absolute left-1/2 -translate-x-1/2 w-[96rem] h-full"></div>
    </div>
  </div>

  <div id="station-msg-box" class="relative max-w-6xl mx-auto mb-3
              rounded-2xl border border-yellow-300
              bg-yellow-50 shadow-sm p-4" style="display: none;">

    <!-- Header -->
    <div class="flex items-center gap-3 mb-2">
      <!-- Warning icon -->
      <div class="flex h-8 w-8 items-center justify-center
                  rounded-full bg-yellow-100 text-yellow-600">
        <svg xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>

      <h2 class="font-semibold text-base text-yellow-800">
        Obvestilo
      </h2>
    </div>

    <!-- Message body -->
    <div id="station-msg"
        class="text-sm text-yellow-900 leading-relaxed">
    </div>

  </div>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-1 lg:px-6 pt-3 grid gap-6 lg:grid-cols-3 items-start">
   
    <!-- Left column: charts + wind rose (same width) -->
    <section class="lg:col-span-2 grid gap-6">
      <!-- Wind Speed Card -->
      <div class="relative bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <!--{{ sleep_overlay() }}-->

        <div class="p-1 pb-2 flex justify-between gap-4 pr-2">
          <div>
            <h2 class="font-semibold text-base">Hitrost vetra</h2>
          </div>

          <div class="flex items-end gap-4 text-right pr-1">
            <!-- MAX block -->
            <div class="leading-tight">
              <div class="flex items-baseline justify-end gap-1">
                <span id="max-value" class="text-xl font-semibold text-rose-500/80">--</span>
                <span id="max-unit" class="text-sm text-slate-500"></span>
              </div>
               <div class="text-xs text-slate-500">sunki</div>
            </div>

            <!-- AVG block -->
            <div class="leading-tight">
              <div class="flex items-baseline justify-end gap-1">
                <span id="avg-value" class="text-3xl font-semibold text-sky-500/80">--</span>
                <span id="avg-unit" class="text-base text-slate-500"></span>
              </div>
               <div class="text-xs text-slate-500">povpreƒçna</div>
            </div>




          </div>
        </div>

        
        <div class="chart-holder relative w-full md:h-[25rem] h-60 ">
          {{ loading_overlay() }}

          <canvas id="wind-chart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex flex-wrap justify-center items-center gap-4 text-center">
          <div class="inline-flex text-base text-slate-500">Nastavitve prikaza:</div>

          <select id="select-display-duration" class="px-3 py-2 text-sm rounded-xl border border-slate-200 bg-white">
              <option value="6" selected>6 ur</option>
              <option value="12">12 ur</option>
              <option value="24">24 ur</option>
              <option value="48">2 dni</option>
              <option value="96">4 dni</option>
              <option value="168">7 dni</option>
              <option value="336">14 dni</option>
              <!--<option value="168">7 dni</option>-->
          </select>

          <div id="toggle-buttons-speed" class="inline-flex rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <button class="px-3 py-1.5 text-sm bg-slate-900 text-white" value="ms">m/s</button>
            <button class="px-3 py-1.5 text-sm bg-white text-slate-600" value="kmh">km/h</button>
          </div>
      </div>
    </div>
      
      <!-- Wind Direction Card -->
      <div class="relative bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <!--{{ sleep_overlay() }}-->

        <div class="p-1 pb-2 flex justify-between gap-4">
          <div>
            <h2 class="font-semibold text-l">Smer vetra</h2>
          </div>
          <div class="text-right">
            <div id="wind-dir-value" class="text-xl font-semibold">--</div>
            <div class="text-xs text-slate-500">trenutna smer</div>
          </div>
        </div>
        <div class="chart-holder relative w-full md:h-[25rem] h-60 ">
          {{ loading_overlay() }}

          <canvas id="dir-chart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
      </div>



      <!-- Temperature chart -->
      <div class="relative bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <!--{{ sleep_overlay() }}-->

        <div class="p-1 pb-2 flex justify-between gap-4">
          <div>
            <h2 class="font-semibold text-l">Temperatura</h2>
              {% if station.temp_msg_warning %}
             <div class="text-xs text-slate-500">‚ö†Ô∏è Temperatura je izmerjena v ohi≈°ju, zato je vi≈°ja od dejanske.</div>
              {% endif %}
            </div>

          <div class="flex items-end gap-4 text-right pr-1">

            <div class="text-right">
              <div class="flex items-baseline justify-end gap-1">
                <span id="hum-value" class="text-xl font-semibold text-[#7ab87d]">--</span>
                <span class="text-sm text-slate-500">%</span>
              </div>

              <div class="text-xs text-slate-500">vlaga</div>
            </div>

            <div class="text-right">
              <div class="flex items-baseline justify-end gap-1">
                <span id="temp-value" class="text-2xl font-semibold text-[#1e88e5]">--</span>
                <span  class="text-sm text-slate-500">ÀöC</span>
              </div>

              <div class="text-xs text-slate-500">temp</div>
            </div>
          </div>
        </div>

        <div class="temp-chart-holder chart-holder relative w-full md:h-[25rem] h-[20rem]">
          {{ loading_overlay() }}

          <canvas id="temp-chart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
      </div>
    </section>



    <!-- Right column: device status + (moved) location/status/notes -->
    <aside class="lg:col-span-1 grid gap-6">
      <!-- Wind rose over map  -->
      <div class="relative bg-white rounded-2xl shadow-sm border border-slate-200 p-4 ">
        <div class="flex items-center justify-between mb-2">
          <h3 class="pl-1 font-semibold">Vetrna ro≈æa</h3>
        </div>




        <input id="time-slider" class="hidden" type="range" min="1" max="300" step="10" value="20" />

        <!-- Map + rose placeholders -->
        <div class="relative flex items-center justify-center w-full rounded-2xl overflow-hidden border border-slate-200">

          {% if station.wind_rose_img %}
            <img src="/veter/static/img/{{ station.wind_rose_img }}" class="absolute inset-0 h-full w-full object-cover z-1"/>
          {% else %}
            <div class="absolute bg-slate-200 inset-0 h-full w-full object-cover z-1"></div>
          {% endif %}
          
          <div id="wind-rose-loading" class="absolute max-h-96 inset-0 flex flex-col items-center justify-center z-10">
            <svg
              class="animate-spin text-white drop-shadow-[0_0_6px_rgba(255,255,255,0.5)]"
              style="height:30px;width:30px"
              viewBox="0 0 24 24"
              fill="none"
            >
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-opacity=".25" stroke-width="4"/>
              <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4"/>
            </svg>

            <!--<span class="text-sm mt-2 text-white drop-shadow">Loading</span>-->
          </div>

          <!-- Map placeholder -->
          <div class="relative max-h-96 aspect-square ">
            <canvas width=800 height=800 id="wind-rose" class="block relative z-2 w-full h-auto "></canvas>
            <div id="tooltip" class="tooltip"></div>
          </div>
        </div>
          
              
        <div class="mt-3 w-auto text-center text-sm text-slate-500">
          Legenda / Porazdelitev hitrosti:
        </div>
    
        <div class="flex w-full -ml-1 mt-1 mb-4 pt-4 justify-center items-center">
          <div id="legend" class="legend">
          </div>
        </div>

        <div class="mt-1 h-[1.5px]"
     style="
        width: 100%;
        background: linear-gradient(
            to right,
            transparent 0%,
            rgb(222, 222, 222) 15%,
            rgb(222, 222, 222) 85%,
            transparent 100%
        );
     ">

      </div>

        <div class="pt-4 w-auto text-center text-sm text-slate-500">
          Razpon prikazanih vrednosti od <b id="rose-data-start">--:--</b> do <b id="rose-data-end">--:--</b>
        </div>
     
        <div class="pt-2 flex justify-center items-end gap-6 text-right pr-1">
           
          <div class="flex flex-col items-center space-y-1">
            <select id="rose-duration-select" class="px-2 py-1 w-24 h-[2.1rem] text-xs rounded-lg border border-slate-200 bg-white">
              <option value="10" >10 min</option>
              <option value="20" >20 min</option>
              <option value="30" >30 min</option>
              <option value="60" selected>1 ura</option>
              <option value="120">2 uri</option>
              <option value="180">3 ure</option>
              <option value="360">6 ur</option>
              <option value="720">12 ur</option>
              <option value="1440">24 ur</option>
            </select>
            <span class="pt-1 text-sm text-slate-500">ƒçasovni obseg</span>
          </div>
          
          <div class="flex flex-col items-center space-y-1">
            <div class="inline-flex items-center border border-slate-200 rounded-lg bg-white overflow-hidden">
              <button id="rose-dec-delay" class="px-2 py-2 hover:bg-slate-200 hover:cursor-pointer text-slate-600 disabled:hover:cursor-default disabled:hover:bg-transparent disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>

              <div class="px-2 h-full text-slate-700 bg-white border-x border-slate-200 text-sm text-center min-w-[2.5rem]">
                <span id="rose-delay-value" class="font-semibold text-sm">0</span><span id="rose-delay-unit" class="text-xs ml-1">min</span> 
              </div>

              <button id="rose-inc-delay" class="px-2 py-2 hover:bg-slate-200 hover:cursor-pointer text-slate-600 disabled:hover:cursor-default disabled:hover:bg-transparent disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <span class="pt-1 text-sm text-slate-500">zamik prikaza</span>
          </div>
          </div>

      </div>

      <!-- Device Status -->
      <div class="relative rounded-2xl shadow-sm border border-slate-200 bg-white p-4">
        <!--{{ sleep_overlay() }}-->

        <h3 id="double-click-show-detailed"  class="font-semibold mb-3 select-none">Parametri postaje</h3> 

        <span id="loading-status-msg">Loading status ...</span>
        
        <!-- Status Bars -->
        <div id="status-graphical-info" class="grid grid-cols-2 gap-3"> </div>
        
        <!-- Status info text values -->
        <div id="status-info" class="mt-4 grid gap-1 text-sm"> </div>

        <button onclick="window.location.href = window.location.pathname + '/info'" class="px-3 py-1 mt-2 text-sm rounded text-slate-500 bg-slate-100 hover:text-slate-800 hover:bg-slate-300">
          Poka≈æi veƒç podrobnosti
        </button>

        <!--
        <button onclick="window.location.href = window.location.pathname + '/config'" class="px-3 py-1 mt-2 text-sm rounded text-slate-500 bg-slate-100 hover:text-slate-800 hover:bg-slate-300">
          Configure
        </button>-->

      </div>

      {% if station.location %}
      <div class="relative rounded-2xl shadow-sm border border-slate-200 bg-white p-4">
        
        <h3 id="double-click-show-detailed"
            class="font-semibold mb-3 select-none">
          Lokacija
        </h3>

        <div class="flex flex-col gap-2 text-sm text-slate-700">


          <!-- Location name -->
          <div class="flex items-center gap-2">
            <span class="text-slate-500">Kje:</span>
            <span class="font-medium">
              {{ station.location.name }}
            </span>
          </div>

          <!-- Coordinates -->
          <div class="flex items-center gap-2">
            <span class="text-slate-500">Koordinate:</span>
            <span class="font-mono">
              {{ station.location.lat }}, {{ station.location.lon }}
            </span>
          </div>

          <!-- Google Maps link -->
          <a
            href="{{ station.location.gmaps_url }}"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 text-sm text-sky-600 hover:text-sky-700
                  hover:underline mt-1 w-fit">

            <!-- Map icon -->
            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4"
              viewBox="0 0 24 24"
              fill="currentColor">
            <path d="M12 2c-3.866 0-7 3.134-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
          </svg>


            Odpri v Google Maps
          </a>
        </div>
      </div>
      {% endif %}

    </aside>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 pb-10 pt-4 text-xs text-slate-400">
    ¬© 2025 Paragliding Wind Station ¬∑ Built with ‚ù§Ô∏è for paragliding ü™Ç
  </footer>
</body>
</html>
