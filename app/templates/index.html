<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="wind.js"></script>
  <script src="script.js"></script>
  <script data-goatcounter="https://stats.to-ni.dev/count" async src="//stats.to-ni.dev/count.js"></script>
  <title>Vetrovna roža – JavaScript (Canvas)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#141c2e; --ink:#dce5ff; --muted:#91a0c3;
      --ring:#2a3550; --accent:#8af; --green:#47d147; --blue:#3a7bd5;
    }
    html,body{height:100%;}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--ink); display:grid; place-items:center}
    .wrap{display:grid; grid-template-columns:minmax(540px,58vw) 320px; gap:24px; align-items:center;}
    .card{background:var(--panel); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);} 
    .canvas-card{position:relative;}
    canvas{display:block; width:100%; height:auto; border-radius:18px}
    .title{padding:16px 18px 0; font-size:20px; font-weight:700; letter-spacing:.2px}
    .legend{padding:14px 18px 16px; display:grid; gap:10px}
    .legend-row{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center}
    .chip{height:12px; width:28px; border-radius:4px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.22)}
    .muted{color:var(--muted)}
    .tooltip{position:absolute; padding:8px 10px; font-size:12px; border-radius:8px; backdrop-filter:blur(6px); background:rgba(25,35,60,.72); color:var(--ink); transform:translate(-50%, -120%); white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .12s ease}
    .controls{padding:16px 18px; display:grid; gap:10px}
    .controls label{font-size:12px; color:var(--muted)}
    input[type=range]{width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card canvas-card">
      <div class="title">Vetrovna roža (frekvenca smeri in hitrosti)</div>
      <canvas id="rose" width="1000" height="1000"></canvas>
      <div id="tooltip" class="tooltip"></div>
    </div>

    <div class="card">
      <div class="title">Legenda & nastavitve</div>
      <div id="legend" class="legend"></div>
      <div class="controls">
        <div>
          <label>Sekcije (smeri)</label>
          <input id="sectors" type="range" min="8" max="36" step="2" value="16" />
        </div>
        <div>
          <label>Notranji krog (delež mirno %)</label>
          <input id="calmPercent" type="range" min="0" max="30" step="1" value="4" />
        </div>
      </div>
    </div>
  </div>

<script>
console.log("Data", data.avgs[0].timestamp);
console.log("Data", data.avgs[0].value);
// ----------------- Konfiguracija -----------------
// Zgornje meje razredov hitrosti (m/s). Zadnji razred bo "> zadnja_meja".
const SPEED_BINS = [1.54, 3.09, 5.14, 8.23, 10.80, 15.50, 20, 25];
// Barve za vse razrede (bins.length + 1). 7 barv.
const COLORS = [
  '#143a8a', // 0–1.54
  '#1f69c1', // 1.54–3.09
  '#268dd9', // 3.09–5.14
  '#37b07a', // 5.14–8.23
  '#5ad24e', // 8.23–10.80
  '#a3ea3a', // 10.80–15.50
  '#eaff3a',  // >15.50
  'rgb(255, 169, 58)',  // >15.50
  'rgb(255, 86, 58)',  // >15.50
];
function generateSamples() {


}

const Sameples = generateSamples()

SAMPLES = result.map(({ valueA: d, valueB: s }) => ({ dir: d, speed: s }));

// ----------------- Pomožne funkcije -----------------
function binIndexForSpeed(v){
  for(let i=0;i<SPEED_BINS.length;i++) if (v <= SPEED_BINS[i]) return i;
  return SPEED_BINS.length; // indeks za "> zadnja meja"
}

function buildLabels(bins){
  const labels = [];
  labels.push(`0–${bins[0].toFixed(2)}`);
  for (let i=1;i<bins.length;i++) labels.push(`${bins[i-1].toFixed(2)}–${bins[i].toFixed(2)}`);
  labels.push(`> ${bins[bins.length-1].toFixed(2)}`);
  return labels;
}

function buildHistogram(samples, sectorCount){
  const perSector = Array.from({length:sectorCount}, () => new Array(SPEED_BINS.length+1).fill(0));
  let calm = 0;
  for(const {dir, speed} of samples){
    if (speed <= 0) { calm++; continue; }
    const sIdx = binIndexForSpeed(speed);
    const sector = Math.floor(((dir%360)+360)%360 / (360/sectorCount));
    perSector[sector][sIdx]++;
  }
  const total = samples.length;
  const sectorTotals = perSector.map(a => a.reduce((x,y)=>x+y,0));
  const pct = perSector.map(a => a.map(v => v*100/total));
  const pctTotals = sectorTotals.map(v => v*100/total);
  const calmPct = calm*100/total;
  return { perSector, pct, pctTotals, calmPct, total };
}

// ----------------- Risanje na Canvas -----------------
const canvas = document.getElementById('rose');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

function drawRings(cx, cy, r, steps){
  ctx.save();
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ring') || '#2a3550';
  ctx.lineWidth = 1;
  for(let i=1;i<=steps;i++){
    ctx.beginPath(); ctx.arc(cx, cy, r*i/steps, 0, Math.PI*2); ctx.stroke();
  }
  ctx.restore();
}

function polarToXY(cx, cy, radius, angleRad){
  return [cx + radius*Math.sin(angleRad), cy - radius*Math.cos(angleRad)];
}

function drawRose(samples, sectorCount, calmInner){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2, R = Math.min(W,H)*0.43;
  const hist = buildHistogram(samples, sectorCount);

  const maxPct = Math.max(12, Math.ceil(Math.max(...hist.pctTotals)));
  drawRings(cx, cy, R, 6);

  // Kompas
  ctx.save();
  ctx.fillStyle = '#cfd9ff';
  ctx.font = '700 28px system-ui';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('N', cx, cy - (R+36));
  ctx.fillText('E', cx + (R+36), cy);
  ctx.fillText('S', cx, cy + (R+36));
  ctx.fillText('W', cx - (R+36), cy);
  ctx.restore();

  // Mirno – notranji krog
  const rCalm = R * (calmInner/100);
  ctx.save();
  ctx.fillStyle = 'rgba(130,160,255,.8)';
  ctx.beginPath(); ctx.arc(cx, cy, rCalm, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#0b1220';
  ctx.beginPath(); ctx.arc(cx, cy, rCalm*0.5, 0, Math.PI*2); ctx.fill();
  ctx.restore();

  // Izriši sektorje
  const dTheta = (2*Math.PI)/sectorCount;
  const offset = (2*Math.PI)/(2*sectorCount);
  const scale = R / maxPct; // px na %

  const stacks = hist.pct.map(arr => {
    const out = []; let acc=0; 
    for(let i=0;i<arr.length;i++){ out.push([acc, acc+arr[i]]); acc+=arr[i]; }
    return out;
  });

  for(let s=0;s<sectorCount;s++){
    const a0 = ((s)*dTheta) - offset, a1 = ((s+1)*dTheta)-offset;
    for(let b=0;b<=SPEED_BINS.length;b++){
      const [p0,p1] = stacks[s][b];
      if (p1<=p0) continue;
      const r0 = rCalm + p0*scale;
      const r1 = rCalm + p1*scale;
      ctx.beginPath();
      const [x0,y0] = polarToXY(cx, cy, r0, a0);
      const [x1,y1] = polarToXY(cx, cy, r0, a1);
      const [x2,y2] = polarToXY(cx, cy, r1, a1);
      const [x3,y3] = polarToXY(cx, cy, r1, a0);
      ctx.moveTo(x0,y0);
      ctx.lineTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.lineTo(x3,y3);
      ctx.closePath();
      ctx.fillStyle = COLORS[b % COLORS.length];
      ctx.globalAlpha = 0.92;
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // osne črte
  ctx.save();
  ctx.strokeStyle = 'rgba(220,230,255,.25)'; ctx.lineWidth=1;
  for(let s=0;s<sectorCount;s++){
    const a = (s+0.5)*dTheta;
    ctx.beginPath();
    const [x0,y0] = polarToXY(cx, cy, rCalm, a);
    const [x1,y1] = polarToXY(cx, cy, R, a);
    ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
  }
  ctx.restore();

  // napis mirno % v sredini
  ctx.save();
  ctx.fillStyle = '#dce5ff';
  ctx.font = '600 22px system-ui';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(hist.calmPct.toFixed(1)+'%', cx, cy);
  ctx.restore();

  // Interaktivni tooltip
  canvas.onmousemove = (ev)=>{
    const rect = canvas.getBoundingClientRect();
    const mx = (ev.clientX-rect.left)* (canvas.width/rect.width);
    const my = (ev.clientY-rect.top) * (canvas.height/rect.height);
    const dx = mx-cx, dy = my-cy;
    const r = Math.hypot(dx,dy), ang = (Math.atan2(dx,-dy)+2*Math.PI)%(2*Math.PI);

    if (r < rCalm || r > R){ tooltip.style.opacity = 0; return; }
    const sector = Math.floor(ang/dTheta);
    const pctStack = stacks[sector];
    const p = (r - rCalm)/scale; // v %
    let bin = pctStack.findIndex(([p0,p1]) => p>=p0 && p<=p1);
    if (bin<0) { tooltip.style.opacity = 0; return; }

    const dirCenter = (sector+0.5)*(360/sectorCount);
    const pctVal = (pctStack[bin][1]-pctStack[bin][0]);
    const last = SPEED_BINS[SPEED_BINS.length-1];
    const speedLabel = bin===0 ? `≤ ${SPEED_BINS[0].toFixed(2)}`
      : (bin<=SPEED_BINS.length-1 ? `${SPEED_BINS[bin-1].toFixed(2)}–${SPEED_BINS[bin].toFixed(2)}`
                                  : `> ${last.toFixed(2)}`);

    tooltip.textContent = `Smer ${dirCenter.toFixed(0)}°, ${speedLabel} m/s → ${pctVal.toFixed(2)}%`;
    tooltip.style.left = ev.clientX + 'px';
    tooltip.style.top  = ev.clientY + 'px';
    tooltip.style.opacity = 1;
  };
  canvas.onmouseleave = ()=> tooltip.style.opacity = 0;

  // ------------ Legenda (POPOLNOMA skladna z bin-i) ------------
  const legend = document.getElementById('legend');
  legend.innerHTML = '';

  const labels = buildLabels(SPEED_BINS); // dolžina = bins+1

  const pctNodes = labels.map((lab,i)=>{
    const row = document.createElement('div'); row.className='legend-row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
    const chip = document.createElement('div'); chip.className='chip'; chip.style.background = COLORS[i % COLORS.length]; left.appendChild(chip);
    const text = document.createElement('div'); text.textContent = `${lab} m/s`; left.appendChild(text);
    const pct = document.createElement('div'); pct.className='muted'; pct.textContent='0.0%';
    row.appendChild(left); row.appendChild(pct); legend.appendChild(row);
    return pct; // vrni DOM node za kasnejšo posodobitev
  });

  // Izračun celotnega % po binu (čez vse sektorje)
  const totalsPerBin = Array(SPEED_BINS.length+1).fill(0);
  for(const sector of hist.pct){ sector.forEach((v,i)=> totalsPerBin[i]+=v); }

  totalsPerBin.forEach((v,i)=>{ if (pctNodes[i]) pctNodes[i].textContent = v.toFixed(1)+'%'; });

  // ----------------- "Testi" / samopreverjanje -----------------
  console.assert(pctNodes.length === totalsPerBin.length, 'Legenda in število razredov se morata ujemati');
}

// ----------------- UI -----------------
const sectorsRange = document.getElementById('sectors');
const calmRange = document.getElementById('calmPercent');
function render(){ drawRose(SAMPLES, +sectorsRange.value, +calmRange.value); }
sectorsRange.addEventListener('input', render);
calmRange.addEventListener('input', render);
render();

// ----------------- Dodatni testi -----------------
(function runSmokeTests(){
  // Test biniranja robnih vrednosti
  console.assert(binIndexForSpeed(0.5) === 0, '0.5 m/s mora pasti v prvi bin');
  console.assert(binIndexForSpeed(1.54) === 0, '1.54 m/s je še vedno v 1. binu');
  console.assert(binIndexForSpeed(1.55) === 1, '1.55 m/s v 2. bin');
  console.assert(binIndexForSpeed(16.0) === SPEED_BINS.length, '> zadnja meja');
})();
</script>
</body>
</html>